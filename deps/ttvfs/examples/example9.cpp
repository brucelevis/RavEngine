
/* ttvfs example #1 - Embedding a zip file in the code */

#include <stdio.h>
#include <ttvfs.h>
#include <ttvfs_zip.h>

// This is a very small zip file, containing a single file: a.txt.
static unsigned char rawData[130] = {
    0x50, 0x4B, 0x03, 0x04, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x29, 0x85,
    0x9B, 0x44, 0x44, 0x9A, 0x72, 0xED, 0x16, 0x00, 0x00, 0x00, 0x16, 0x00,
    0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x61, 0x2E, 0x74, 0x78, 0x74, 0x61,
    0x2E, 0x74, 0x78, 0x74, 0x3A, 0x20, 0x49, 0x6E, 0x2D, 0x6D, 0x65, 0x6D,
    0x6F, 0x72, 0x79, 0x20, 0x66, 0x69, 0x6C, 0x65, 0x2E, 0x50, 0x4B, 0x01,
    0x02, 0x14, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x29, 0x85, 0x9B,
    0x44, 0x44, 0x9A, 0x72, 0xED, 0x16, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00,
    0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x2E, 0x74, 0x78, 0x74,
    0x50, 0x4B, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00,
    0x33, 0x00, 0x00, 0x00, 0x39, 0x00, 0x00, 0x00, 0x00, 0x00
};

int main(int argc, char *argv[])
{
    ttvfs::Root vfs;
    // Note that we're not adding a disk loader here.
    vfs.AddArchiveLoader(new ttvfs::VFSZipArchiveLoader);

    // By default, the buffer is left untouched when the MemFile is deleted.
    // Use new because refcounting will delete the file when vfs is destroyed.
    // Use a CountedPtr so that we don't have to worry about cleaning up if something fails.
    // The file name is arbitrarily chosen, but the subdir representing the zip file
    // will have this name.
    ttvfs::CountedPtr<ttvfs::MemFile> mf = new ttvfs::MemFile("memdata.zip", rawData, sizeof(rawData));

    // Make all files from the archive available in the root.
    // The MemFile itself can NOT be accessed from the vfs root.
    if(!vfs.AddArchive(mf, ""))
    {
        puts("ERROR adding embedded archive");
        return 1;
    }

    char buf[513];
    size_t bytes = 0;
    ttvfs::File *vf = vfs.GetFile("a.txt");
    if(!vf || !vf->open("r") || !(bytes = vf->read(buf, 512)) )
    {
        puts("ERROR reading from embedded a.txt");
        return 2;
    }
    buf[bytes] = 0;
    puts(buf);
    return 0;
}

